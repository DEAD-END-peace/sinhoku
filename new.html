<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ–¹ä½è§’ãƒ»è·é›¢è¨ˆç®—ãƒ„ãƒ¼ãƒ«ï¼ˆåœ°å›³æ©Ÿèƒ½ä»˜ãï¼‰</title>
  <link rel="icon" href="logo.png" type="image/png">
  <!-- Leaflet.js ã® CSS ã‚’è¿½åŠ  -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root {
      --system-blue: #007aff;
      --system-background: #f0f2f5;
      --secondary-background: #ffffff;
      --separator-color: #e5e5e5;
      --text-color: #1d1d1f;
      --secondary-text-color: #8a8a8e;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--system-background);
      margin: 0;
      padding: 1em;
      color: var(--text-color);
    }
    .container {
      max-width: 680px;
      margin: 0 auto;
    }
    h2 {
      color: var(--text-color);
      font-size: 24px;
      font-weight: 600;
    }
    .tab-nav {
      display: flex;
      background-color: #e9e9eb;
      border-radius: 8px;
      padding: 3px;
      margin-bottom: 1.5em;
    }
    .tab-button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background-color: transparent;
      color: var(--secondary-text-color);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .tab-button.active {
      background-color: var(--secondary-background);
      color: var(--text-color);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tab-panel {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }
    .tab-panel.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1em;
      background: var(--secondary-background);
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid var(--separator-color);
      padding: 0.75em 0.5em;
      text-align: center;
    }
    th {
      background-color: #f7f7f7;
      font-weight: 500;
    }
    input {
      width: 95%;
      box-sizing: border-box;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .dmsInput { display: none; }
    .decimalInput { display: table-cell; }
    button {
      margin: 0.5em 0.2em;
      padding: 0.6em 1.2em;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .button-primary {
      background: var(--system-blue);
      color: #fff;
    }
    .button-primary:hover { background: #0056b3; }
    .button-secondary {
        background-color: #e9e9eb;
        color: var(--text-color);
    }
    .button-secondary:hover { background-color: #dcdce1; }
    .card {
      background: var(--secondary-background);
      border: 1px solid var(--separator-color);
      border-radius: 12px;
      padding: 15px;
      margin-top: 1em;
    }
    .card h3 { margin: 0 0 10px; font-size: 18px; }
    #shareURL { width: 100%; padding: 0.5em; margin-top: 0.5em; font-size: 0.9em; box-sizing: border-box; }
    
    /* Map container style */
    #map { 
      width: 100%; 
      height: 400px; /* Adjust height as needed */
      border: 1px solid var(--separator-color); 
      background: #fdfdfd; 
      border-radius: 8px;
      margin-top: 10px;
    }
    .note { font-size: 12px; color: var(--secondary-text-color); margin-top: 5px; }
    ul { padding-left: 1.2em; }
    li { margin-bottom: 0.5em; }
    .map-link { text-decoration: none; color: var(--system-blue); cursor: pointer; background: transparent; border: none; padding: 0; }
    #toast { visibility: hidden; min-width: 180px; max-width: 90vw; background-color: rgba(0,0,0,0.75); color: #fff; text-align: center; border-radius: 12px; padding: 12px 16px; position: fixed; z-index: 1000; bottom: 24px; left: 50%; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: all 0.35s ease; }
    #toast.show { visibility: visible; opacity: 1; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; z-index: 1200; }
    .modal-backdrop.show { display: flex; }
    .modal { width: min(92vw, 420px); background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.2); padding: 18px; }
    .modal h4 { margin: 0 0 12px; font-size: 18px; }
    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-outline { background: #fff; color: var(--system-blue); border: 1px solid var(--system-blue); padding: 10px 12px; border-radius: 8px; cursor: pointer; }
    .btn-outline:hover { background: #f0f8ff; }
    .btn-close { margin-top: 8px; width: 100%; background: #e5e7eb; color: #333; border: none; border-radius: 8px; padding: 10px 12px; cursor: pointer; }
    .btn-close:hover { background: #d1d5db; }

    .help-section {
        margin-bottom: 1.5em;
    }
    .help-section h4 {
        font-size: 1.1em;
        border-bottom: 1px solid var(--separator-color);
        padding-bottom: 8px;
        margin-bottom: 12px;
    }
    .help-section p, .help-section li {
        font-size: 0.95em;
        line-height: 1.6;
        color: var(--secondary-text-color);
    }
    .help-section ul, .help-section ol {
        padding-left: 20px;
    }
    .help-section ul ul {
      margin-top: 8px;
    }
    .help-section code {
      font-family: monospace;
      background: #eee;
      padding: 2px 4px;
      border-radius: 3px;
    }
    /* For Leaflet attribution */
    .leaflet-container .leaflet-control-attribution {
      font-size: 10px;
    }
    /* SVG Marker Style */
    .leaflet-div-icon {
        background: transparent;
        border: none;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>æ–¹ä½è§’ãƒ»è·é›¢è¨ˆç®—ãƒ„ãƒ¼ãƒ«</h2>
    <button type="button" id="showHelpBtn" class="button-secondary" style="margin-bottom: 1em;">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ï¼ˆãƒ˜ãƒ«ãƒ—ï¼‰</button>

    <div class="tab-nav">
      <button class="tab-button active" data-tab="tab-calc">å…¥åŠ›</button>
      <button class="tab-button" data-tab="tab-results">çµæœ</button>
      <button class="tab-button" data-tab="tab-tools">ãƒ„ãƒ¼ãƒ«</button>
    </div>

    <div id="tab-calc" class="tab-panel active">
      <form onsubmit="return false;">
        <table>
          <tr>
            <th>åœ°ç‚¹</th>
            <th>ç·¯åº¦ãƒ»çµŒåº¦ãƒšã‚¢</th>
            <th class="dmsInput">ç·¯åº¦(åº¦åˆ†ç§’)</th>
            <th class="dmsInput">çµŒåº¦(åº¦åˆ†ç§’)</th>
            <th class="decimalInput">ç·¯åº¦(10é€²)</th>
            <th class="decimalInput">çµŒåº¦(10é€²)</th>
          </tr>
          <tr><td>A</td><td><input id="latlonA" placeholder="ä¾‹: åŒ—33.3Â°, æ±130.5Â°"></td><td class="dmsInput"><input id="latA_deg" size="3">Â° <input id="latA_min" size="2">â€² <input type="number" id="latA_sec" size="4">â€³</td><td class="dmsInput"><input id="lonA_deg" size="3">Â° <input id="lonA_min" size="2">â€² <input type="number" id="lonA_sec" size="4">â€³</td><td class="decimalInput"><input id="latA_dec"></td><td class="decimalInput"><input id="lonA_dec"></td></tr>
          <tr><td>B</td><td><input id="latlonB"></td><td class="dmsInput"><input id="latB_deg" size="3">Â° <input id="latB_min" size="2">â€² <input type="number" id="latB_sec" size="4">â€³</td><td class="dmsInput"><input id="lonB_deg" size="3">Â° <input id="lonB_min" size="2">â€² <input type="number" id="lonB_sec" size="4">â€³</td><td class="decimalInput"><input id="latB_dec"></td><td class="decimalInput"><input id="lonB_dec"></td></tr>
          <tr><td>C</td><td><input id="latlonC"></td><td class="dmsInput"><input id="latC_deg" size="3">Â° <input id="latC_min" size="2">â€² <input type="number" id="latC_sec" size="4">â€³</td><td class="dmsInput"><input id="lonC_deg" size="3">Â° <input id="lonC_min" size="2">â€² <input type="number" id="lonC_sec" size="4">â€³</td><td class="decimalInput"><input id="latC_dec"></td><td class="decimalInput"><input id="lonC_dec"></td></tr>
          <tr><td>D</td><td><input id="latlonD"></td><td class="dmsInput"><input id="latD_deg" size="3">Â° <input id="latD_min" size="2">â€² <input type="number" id="latD_sec" size="4">â€³</td><td class="dmsInput"><input id="lonD_deg" size="3">Â° <input id="lonD_min" size="2">â€² <input type="number" id="lonD_sec" size="4">â€³</td><td class="decimalInput"><input id="latD_dec"></td><td class="decimalInput"><input id="lonD_dec"></td></tr>
        </table>
        <button type="button" class="button-primary" onclick="switchToResultsTab()">çµæœã‚’è¡¨ç¤º</button>
        <button type="button" id="getLocationBtn" class="button-secondary" style="background-color: #4CAF50; color: white;">ç¾åœ¨åœ°ã‚’Aã«è¨­å®šğŸŒ</button>
        <button type="button" onclick="toggleInputMode()" class="button-secondary">å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿: <span id="inputMode">10é€²å…¥åŠ›</span></button>
      </form>
    </div>

    <div id="tab-results" class="tab-panel">
      <div class="card">
        <h3>è¨ˆç®—çµæœ</h3>
        <div id="results"></div>
      </div>
       <div class="card">
        <h3>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ—</h3>
        <div class="note">å„åœ°ç‚¹ã®ä½ç½®é–¢ä¿‚ã‚’åœ°å›³ä¸Šã§ç¢ºèªã§ãã¾ã™ã€‚</div>
        <div id="map"></div>
      </div>
      <div class="card">
        <h3>ãƒãƒƒãƒ—ã§é–‹ãï¼ˆå¤–éƒ¨ã‚¢ãƒ—ãƒªï¼‰</h3>
        <div id="mapLinks"></div>
        <ul id="mapLinksArb"></ul>
      </div>
    </div>

    <div id="tab-tools" class="tab-panel">
      <div class="card">
        <h3>ä»»æ„ã®è§’åº¦ãƒ»è·é›¢ã§ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </h3>
        <div class="note">åŸºæº–ç‚¹ã¯ã€Œå…¥åŠ›ã€ã‚¿ãƒ–ã®Aç‚¹ã§ã™ã€‚</div>
        <div class="bearing-row" style="margin:1em 0;">
          <label>è§’åº¦(Â°): <input id="any_bearing" type="number" step="0.1" placeholder="90"></label><br>
          <label>è·é›¢: <input id="any_distance" type="number" step="0.001" placeholder="1.5"></label>
          <select id="any_unit"><option value="km">km</option><option value="m">m</option></select>
        </div>
        <button type="button" id="any_add_btn" class="button-secondary">ã“ã®æ¡ä»¶ã§ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </button>
        <button type="button" id="any_clear_btn" class="button-secondary" style="background:#ff453a; color:white;">ã‚¯ãƒªã‚¢</button>
        <ul id="arbList"></ul>
      </div>
       <div class="card">
        <h3>å…±æœ‰URL</h3>
        <input type="text" id="shareURL" readonly placeholder="ã“ã“ã«ç”ŸæˆURLãŒè¡¨ç¤ºã•ã‚Œã¾ã™">
        <button id="shareBtn" onclick="generateShareURL()" class="button-secondary">å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>
  <div id="mapPickerBackdrop" class="modal-backdrop" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="mapPickerTitle"><h4 id="mapPickerTitle">é–‹ããƒãƒƒãƒ—ã‚’é¸æŠ</h4><div class="btn-row"><button id="btnApple" class="btn-outline" type="button">Appleãƒãƒƒãƒ—</button><button id="btnGoogle" class="btn-outline" type="button">Googleãƒãƒƒãƒ—</button></div><button id="btnClosePicker" class="btn-close" type="button">é–‰ã˜ã‚‹</button></div></div>
  
  <!-- â–¼â–¼â–¼ ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’æ›´æ–° â–¼â–¼â–¼ -->
  <div id="help-modal" class="modal-backdrop" style="display: none;">
    <div class="modal" style="max-height: 85vh; overflow-y: auto; text-align: left;">
      <h3 style="text-align: center; margin-top:0;">ã€Œæ–¹ä½è§’ãƒ»è·é›¢è¨ˆç®—ãƒ„ãƒ¼ãƒ«ã€ã®ä½¿ã„æ–¹</h3>
      
      <div class="help-section">
          <h4>ã¯ã˜ã‚ã«</h4>
          <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€åŸºæº–ç‚¹ã‹ã‚‰ç›®æ¨™åœ°ç‚¹ã¸ã®ã€Œæ–¹è§’ï¼ˆæ–¹ä½è§’ï¼‰ã€ã¨ã€Œç›´ç·šè·é›¢ã€ã‚’è¨ˆç®—ã—ã€åœ°å›³ä¸Šã«è¦–è¦šçš„ã«è¡¨ç¤ºã—ã¾ã™ã€‚</p>
      </div>

      <div class="help-section">
          <h4>åŸºæœ¬çš„ãªä½¿ã„æ–¹</h4>
          <ol>
              <li><strong>åŸºæº–ç‚¹ï¼ˆAåœ°ç‚¹ï¼‰ã‚’æ±ºã‚ã‚‹</strong><br>
                  <code>ç¾åœ¨åœ°ã‚’Aã«è¨­å®šğŸŒ</code> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹ã€ç·¯åº¦çµŒåº¦ã‚’ç›´æ¥å…¥åŠ›ã—ã¾ã™ã€‚
              </li>
              <li><strong>ç›®çš„åœ°ï¼ˆB, C, D...ï¼‰ã‚’æ±ºã‚ã‚‹</strong><br>
                  ç›®çš„åœ°ã®ç·¯åº¦çµŒåº¦ã‚’åŒæ§˜ã«å…¥åŠ›ã—ã¾ã™ã€‚
              </li>
              <li><strong>çµæœã‚’è¦‹ã‚‹</strong><br>
                  <code>çµæœã‚’è¡¨ç¤º</code> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã€Œçµæœã€ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚è¨ˆç®—çµæœã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </li>
          </ol>
      </div>

      <div class="help-section">
          <h4>åœ°å›³ã®èª­ã¿æ–¹</h4>
          <p>ã€Œçµæœã€ã‚¿ãƒ–ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ—ã«ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          <ul>
              <li><strong>åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼</strong><br>
                A, B, C, Dã‚„ãƒ„ãƒ¼ãƒ«ã§è¿½åŠ ã—ãŸåœ°ç‚¹ãŒã€æ–‡å­—ã‚„æ•°å­—å…¥ã‚Šã®ãƒ”ãƒ³ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
              </li>
              <li><strong>çœŸåŒ—ãƒ©ã‚¤ãƒ³ (é’ã„ç·š)</strong><br>
                Aåœ°ç‚¹ã‹ã‚‰çœŸåŒ—ï¼ˆæ–¹ä½è§’0åº¦ï¼‰ã®æ–¹å‘ã¸2kmä¼¸ã³ã‚‹é’ã„å®Ÿç·šã§ã™ã€‚æ–¹è§’ã‚’æŠŠæ¡ã™ã‚‹éš›ã®åŸºæº–ç·šã¨ãªã‚Šã¾ã™ã€‚
              </li>
              <li><strong>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ©ã‚¤ãƒ³ (ã‚«ãƒ©ãƒ•ãƒ«ãªç·š)</strong><br>
                B, C, Dã‚„ãƒ„ãƒ¼ãƒ«ã§è¿½åŠ ã—ãŸå„åœ°ç‚¹ã‹ã‚‰ã€åŸºæº–ç‚¹Aã¸å‘ã‹ã£ã¦å¼•ã‹ã‚ŒãŸè‰²ä»˜ãã®å®Ÿç·šã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å„åœ°ç‚¹ã‹ã‚‰è¦‹ã¦Aåœ°ç‚¹ãŒã©ã®æ–¹å‘ã«ã‚ã‚‹ã‹ãŒç›´æ„Ÿçš„ã«åˆ†ã‹ã‚Šã¾ã™ã€‚è‰²ã¯è‡ªå‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚
              </li>
          </ul>
      </div>

      <div class="help-section">
          <h4>å„æ©Ÿèƒ½ã®èª¬æ˜</h4>
          <ul>
              <li><strong>å…¥åŠ›ã‚¿ãƒ–</strong><br>
                  <code>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</code> ãƒœã‚¿ãƒ³ã§ã€ç·¯åº¦çµŒåº¦ã®å…¥åŠ›ã‚’ã€Œ10é€²æ•°ï¼ˆä¾‹: 33.589ï¼‰ã€ã¨ã€Œ60é€²æ•°ï¼ˆåº¦åˆ†ç§’ï¼‰ã€ã§åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚
              </li>
              <li><strong>çµæœã‚¿ãƒ–</strong><br>
                  è¨ˆç®—çµæœã®è¡¨ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ—ã€å¤–éƒ¨åœ°å›³ã‚¢ãƒ—ãƒªã§é–‹ããŸã‚ã®ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </li>
              <li><strong>ãƒ„ãƒ¼ãƒ«ã‚¿ãƒ–</strong>
                  <ul>
                      <li><strong>ä»»æ„ã®è§’åº¦ãƒ»è·é›¢ã§ãƒªãƒ³ã‚¯ã‚’è¿½åŠ :</strong><br>
                        Aåœ°ç‚¹ã‹ã‚‰ã€ŒåŒ—æ±ï¼ˆ45Â°ï¼‰ã®æ–¹è§’ã¸500mã€ã®ã‚ˆã†ãªã€æ–¹è§’ã¨è·é›¢ãŒåˆ†ã‹ã£ã¦ã„ã‚‹åœ°ç‚¹ã‚’åœ°å›³ä¸Šã«è¿½åŠ ã§ãã¾ã™ã€‚
                      </li>
                      <li><strong>å…±æœ‰URL:</strong><br>
                        å…¥åŠ›ã—ãŸå…¨åœ°ç‚¹ã®æƒ…å ±ã‚’å«ã‚“ã URLã‚’ç”Ÿæˆãƒ»ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚
                      </li>
                  </ul>
              </li>
          </ul>
      </div>
      <button id="closeHelpBtn" class="btn-close">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <!-- â–²â–²â–² ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ›´æ–°ã“ã“ã¾ã§ â–²â–²â–² -->
  
  <!-- Leaflet.js ã® JavaScript ã‚’è¿½åŠ  -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    let isDecimal = true;
    const PTS = ['A','B','C','D'];
    
    // --- Map related variables ---
    let map = null;
    let mapMarkers = [];
    let mapPolylines = [];
    let arbitraryPointCounter = 1;
    let mapArbitraryPoints = []; // â–¼â–¼â–¼ ä»»æ„åœ°ç‚¹ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹é…åˆ— â–¼â–¼â–¼
    
    // â–¼â–¼â–¼ ãƒ©ã‚¤ãƒ³æç”»ç”¨ã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’å®šç¾© â–¼â–¼â–¼
    const lineColors = [
        '#E53935', '#D81B60', '#8E24AA', '#5E35B1', '#3949AB', '#1E88E5', 
        '#039BE5', '#00ACC1', '#00897B', '#43A047', '#7CB342', '#C0CA33', 
        '#FDD835', '#FFB300', '#FB8C00', '#F4511E'
    ];
    // --- End Map variables ---

    function isAppleMobile(){ const ua = navigator.userAgent || ''; const iOS = /iPhone|iPad|iPod/i.test(ua); const iPadLike = navigator.platform === 'MacIntel' && typeof navigator.maxTouchPoints === 'number' && navigator.maxTouchPoints > 1; return iOS || iPadLike; }
    function isAndroid(){ return /Android/i.test(navigator.userAgent || ''); }
    function openExternal(url) { if (isAppleMobile()) { window.location.assign(url); } else { window.open(url, '_blank', 'noopener'); } }
    function toggleInputMode() { isDecimal = !isDecimal; document.getElementById('inputMode').textContent = isDecimal ? '10é€²å…¥åŠ›' : '60é€²å…¥åŠ›'; document.querySelectorAll('.decimalInput').forEach(el => el.style.display = isDecimal ? 'table-cell' : 'none'); document.querySelectorAll('.dmsInput').forEach(el => el.style.display = isDecimal ? 'none' : 'table-cell'); PTS.forEach(pt => { const pair = readPair(pt); if (pair && Number.isFinite(pair.lat) && Number.isFinite(pair.lon)) { setDecimal(pt, pair.lat, pair.lon); setDMSFromDecimal(pt, pair.lat, pair.lon); } else { const dec = readDecimal(pt); if (dec) { setPair(pt, dec.lat, dec.lon); setDMSFromDecimal(pt, dec.lat, dec.lon); } else { const dms = readDMS(pt); if (dms) { setDecimal(pt, dms.lat, dms.lon); setPair(pt, dms.lat, dms.lon); } } } }); calculate(); }
    
    function readPair(pt) {
        const val = document.getElementById('latlon' + pt).value.trim();
        if (!val) return null;
        const s = val.replace(/^\s*\(|\)\s*$/g, '');
        const flexibleRegex = /([NSåŒ—å—])?\s*([\d\.]+)\s*[Â°åº¦]?\s*([NSåŒ—å—])?\s*[,ã€\s]+\s*([EWæ±è¥¿])?\s*([\d\.]+)\s*[Â°åº¦]?\s*([EWæ±è¥¿])?/i;
        const match = s.match(flexibleRegex);
        if (match) {
            let lat = parseFloat(match[2]);
            let lon = parseFloat(match[5]);
            const latDir = match[1] || match[3];
            if (latDir && /[Så—]/i.test(latDir)) lat = -Math.abs(lat);
            const lonDir = match[4] || match[6];
            if (lonDir && /[Wè¥¿]/i.test(lonDir)) lon = -Math.abs(lon);
            if (Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
        }
        const arr = s.split(',').map(v => parseFloat(v));
        if (arr.length === 2 && Number.isFinite(arr[0]) && Number.isFinite(arr[1])) return { lat: arr[0], lon: arr[1] };
        return null;
    }

    function readDecimal(pt){ const la = parseFloat(document.getElementById('lat'+pt+'_dec').value); const lo = parseFloat(document.getElementById('lon'+pt+'_dec').value); if (Number.isFinite(la) && Number.isFinite(lo)) return {lat:la, lon:lo}; return null; }
    function dmsToDecimal(deg, min, sec) { const D = parseFloat(deg), M = parseFloat(min), S = parseFloat(sec); if (!Number.isFinite(D) || !Number.isFinite(M) || !Number.isFinite(S)) return NaN; const sign = D < 0 ? -1 : 1; return sign * (Math.abs(D) + Math.abs(M)/60 + Math.abs(S)/3600); }
    function readDMS(pt){ const la = dmsToDecimal( document.getElementById('lat'+pt+'_deg').value, document.getElementById('lat'+pt+'_min').value, document.getElementById('lat'+pt+'_sec').value ); const lo = dmsToDecimal( document.getElementById('lon'+pt+'_deg').value, document.getElementById('lon'+pt+'_min').value, document.getElementById('lon'+pt+'_sec').value ); if (Number.isFinite(la) && Number.isFinite(lo)) return {lat:la, lon:lo}; return null; }
    function setPair(pt, lat, lon){ document.getElementById('latlon'+pt).value = `${lat.toFixed(6)},${lon.toFixed(6)}`; }
    function setDecimal(pt, lat, lon){ document.getElementById('lat'+pt+'_dec').value = Number.isFinite(lat)? lat.toFixed(6) : ''; document.getElementById('lon'+pt+'_dec').value = Number.isFinite(lon)? lon.toFixed(6) : ''; }
    function decimalToDMS(val){ if (!Number.isFinite(val)) return {deg:'',min:'',sec:''}; const sign = val < 0 ? -1 : 1; const abs = Math.abs(val); const deg = Math.trunc(abs) * sign; const minFloat = (abs - Math.trunc(abs)) * 60; const min = Math.trunc(minFloat); const sec = ((minFloat - min) * 60).toFixed(2); return {deg, min, sec}; }
    function setDMSFromDecimal(pt, lat, lon){ const La = decimalToDMS(lat), Lo = decimalToDMS(lon); document.getElementById('lat'+pt+'_deg').value = La.deg; document.getElementById('lat'+pt+'_min').value = La.min; document.getElementById('lat'+pt+'_sec').value = La.sec; document.getElementById('lon'+pt+'_deg').value = Lo.deg; document.getElementById('lon'+pt+'_min').value = Lo.min; document.getElementById('lon'+pt+'_sec').value = Lo.sec; }
    
    function calculate() { 
        const pts=['A','B','C','D'], coords={}, parts=[]; 
        let mapHtml = '<ul>'; 
        pts.forEach(pt => { 
            let lat, lon; 
            if (!isDecimal) { 
                const d = readDMS(pt); 
                lat = d? d.lat : NaN; 
                lon = d? d.lon : NaN; 
            } else { 
                const p = readPair(pt) || readDecimal(pt); 
                lat = p? p.lat : NaN; 
                lon = p? p.lon : NaN; 
            } 
            if(Number.isFinite(lat) && Number.isFinite(lon)) {
                parts.push(`${lat.toFixed(6)},${lon.toFixed(6)}`);
            }
            coords[pt] = [lat, lon]; 
            const disabled = (!Number.isFinite(lat) || !Number.isFinite(lon)); 
            const link = disabled ? `<span>${pt}ç‚¹: -</span>` : `<button type="button" class="map-link" onclick="openMap(event, ${lat}, ${lon})">${pt}ç‚¹: ãƒãƒƒãƒ—ã§é–‹ã</button>`; 
            mapHtml += `<li>${link}</li>`; 
        }); 
        document.getElementById('mapLinks').innerHTML = mapHtml + '</ul>'; 
        
        let tbl = '<table><tr><th>åŒºé–“</th><th>æ–¹ä½è§’</th><th>è·é›¢(km)</th></tr>';
        const validPts = ['B','C','D'].filter(pt => Number.isFinite(coords[pt][0]) && Number.isFinite(coords[pt][1]) && Number.isFinite(coords.A[0]) && Number.isFinite(coords.A[1])); 
        validPts.forEach(pt => { 
            const [a1,b1] = coords.A, [a2,b2] = coords[pt]; 
            const r = calcDistanceAndBearing(a1,b1,a2,b2); 
            tbl += `<tr><td>Aâ†’${pt}</td><td>${r.dms}</td><td>${r.dist.toFixed(3)}</td></tr>`; 
        }); 
        document.getElementById('results').innerHTML = tbl + '</table>'; 
        
        // --- Map Update Logic ---
        updateMap(coords);
        // --- End Map Update Logic ---
        
        const base = location.origin + location.pathname.replace(/\/[^/]*$/, '/'); 
        document.getElementById('shareURL').value = `${base}?location=${parts.join('-')}`; 
    }

    function calcDistanceAndBearing(lat1, lon1, lat2, lon2) { const R = 6371; const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2), Î”Î» = toRad(lon2 - lon1); const y = Math.sin(Î”Î»)*Math.cos(Ï†2); const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»); const dec = (Math.atan2(y,x)*180/Math.PI + 360) % 360; const deg = Math.floor(dec), min = Math.floor((dec-deg)*60), sec = (((dec-deg)*60-min)*60).toFixed(1); const dms = `${deg}Â°${min}â€²${sec}â€³`; const a = Math.sin((Ï†2-Ï†1)/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2; const dist = R * 2 * Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return { decimal:dec, dms, dist }; }
    function toRad(d) { return d*Math.PI/180; }
    let pendingCoord = null; const backdrop = document.getElementById('mapPickerBackdrop'); const btnApple = document.getElementById('btnApple'); const btnGoogle = document.getElementById('btnGoogle'); const btnClosePicker = document.getElementById('btnClosePicker');
    function openPicker(lat, lon){ pendingCoord = {lat, lon}; backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }
    function closePicker(){ backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); pendingCoord = null; }
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closePicker(); });
    btnClosePicker.addEventListener('click', closePicker);
    btnApple.addEventListener('click', ()=>{ if(!pendingCoord) return; const {lat, lon} = pendingCoord; const aHttp = `https://maps.apple.com/?q=${lat},${lon}`; openExternal(aHttp); closePicker(); });
    btnGoogle.addEventListener('click', ()=>{ if(!pendingCoord) return; const {lat, lon} = pendingCoord; openExternal(`https://www.google.com/maps?q=${lat},${lon}`); closePicker(); });
    function openMap(e, lat, lon){ if (e) e.preventDefault(); const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`; if (isAndroid()) { openExternal(googleMapsUrl); return; } if (isAppleMobile()) { openPicker(lat, lon); return; } openExternal(googleMapsUrl); }
    async function generateShareURL() { calculate(); const url = document.getElementById('shareURL').value; const btn = document.getElementById('shareBtn'); try { await copyText(url); showToast('å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); } catch (e) { showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); } }
    async function copyText(text) { if (!text) throw new Error('empty'); if (navigator.clipboard) { await navigator.clipboard.writeText(text); return; } const ta = document.createElement('textarea'); ta.value = text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    function showToast(msg) { const toast = document.getElementById('toast'); toast.textContent = msg; toast.classList.add('show'); clearTimeout(showToast._timer); showToast._timer = setTimeout(() => { toast.classList.remove('show'); }, 2000); }
    
    function parseUrlInputs() { const params=new URLSearchParams(window.location.search); const loc=params.get('location')||''; const pairs=loc.split('-'); PTS.forEach((pt,i)=>{ if(pairs[i]){ document.getElementById('latlon'+pt).value=pairs[i]; const [la,lo]=pairs[i].split(',').map(s=>s.trim()); const lat=parseFloat(la), lon=parseFloat(lo); if (Number.isFinite(lat) && Number.isFinite(lon)) { setDecimal(pt, lat, lon); setDMSFromDecimal(pt, lat, lon); } } }); calculate(); }
    function destPoint(latDeg, lonDeg, bearingDeg, distanceKm) { const R = 6371; const Î´ = distanceKm / R; const Î¸ = ((bearingDeg % 360) + 360) % 360 * Math.PI/180; const Ï†1 = latDeg * Math.PI/180; const Î»1 = lonDeg * Math.PI/180; const sinÏ†1 = Math.sin(Ï†1), cosÏ†1 = Math.cos(Ï†1); const sinÎ´ = Math.sin(Î´), cosÎ´ = Math.cos(Î´); const sinÎ¸ = Math.sin(Î¸), cosÎ¸ = Math.cos(Î¸); const sinÏ†2 = sinÏ†1 * cosÎ´ + cosÏ†1 * sinÎ´ * cosÎ¸; const Ï†2 = Math.asin(sinÏ†2); const y = sinÎ¸ * sinÎ´ * cosÏ†1; const x = cosÎ´ - sinÏ†1 * sinÏ†2; const Î»2 = Î»1 + Math.atan2(y, x); const lat2 = Ï†2 * 180/Math.PI; let lon2 = Î»2 * 180/Math.PI; lon2 = ((lon2 + 540) % 360) - 180; return { lat: lat2, lon: lon2 }; }
    function readPointA() { let lat, lon; if (!isDecimal) { const d = readDMS('A'); lat = d ? d.lat : NaN; lon = d ? d.lon : NaN; } else { const p = readPair('A') || readDecimal('A'); lat = p ? p.lat : NaN; lon = p ? p.lon : NaN; } if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null; return { lat, lon }; }
    
    function createMarkerIcon(label, color) {
        const svg = `
            <svg width="32" height="42" viewBox="0 0 32 42" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                        <feDropShadow dx="1" dy="2" stdDeviation="2" flood-color="#000000" flood-opacity="0.4"/>
                    </filter>
                </defs>
                <path d="M16 0 C7.163 0 0 7.163 0 16 C0 24.837 16 42 16 42 C16 42 32 24.837 32 16 C32 7.163 24.837 0 16 0 Z" fill="${color}" filter="url(#shadow)"></path>
                <circle cx="16" cy="16" r="12" fill="white"></circle>
                <text x="16" y="21" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#333">${label}</text>
            </svg>`;
        return L.divIcon({
            html: svg,
            className: 'leaflet-div-icon',
            iconSize: [32, 42],
            iconAnchor: [16, 42]
        });
    }
    
    function addArbitraryLink() {
        const A = readPointA();
        if (!A) {
            showToast('åŸºæº–ç‚¹AãŒæœªå…¥åŠ›ã§ã™');
            return;
        }
        const bearing = parseFloat(document.getElementById('any_bearing').value);
        let distVal = parseFloat(document.getElementById('any_distance').value);
        const unit = document.getElementById('any_unit').value;
        if (!Number.isFinite(bearing) || !Number.isFinite(distVal) || distVal < 0) {
            showToast('æœ‰åŠ¹ãªè§’åº¦ãƒ»è·é›¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        if (unit === 'm') distVal /= 1000.0;
        
        const d = destPoint(A.lat, A.lon, bearing, distVal);
        const normBearing = (((bearing % 360) + 360) % 360).toFixed(1);
        
        mapArbitraryPoints.push({ lat: d.lat, lon: d.lon, id: arbitraryPointCounter });

        const labelText = `${arbitraryPointCounter}: è§’åº¦${normBearing}Â° è·é›¢${distVal.toFixed(3)}km`;
        const createLink = (lat, lon) => {
            const li = document.createElement('li');
            const btn = document.createElement('button');
            btn.className = 'map-link';
            btn.type = 'button';
            btn.textContent = `${labelText} â†’ ãƒãƒƒãƒ—ã§é–‹ã`;
            btn.addEventListener('click', (e) => openMap(e, lat, lon));
            li.appendChild(btn);
            return li;
        };
        document.getElementById('arbList').appendChild(createLink(d.lat, d.lon));
        document.getElementById('mapLinksArb').appendChild(createLink(d.lat, d.lon));
        
        arbitraryPointCounter++;
        showToast('ä»»æ„åœ°ç‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        
        calculate();
    }
    
    function clearArbitrary() {
        document.getElementById('any_bearing').value = '';
        document.getElementById('any_distance').value = '';
        document.getElementById('any_unit').value = 'km';
        document.getElementById('arbList').innerHTML = '';
        document.getElementById('mapLinksArb').innerHTML = '';
        
        mapArbitraryPoints = [];
        arbitraryPointCounter = 1;

        showToast('ä»»æ„åœ°ç‚¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        
        calculate();
    }
    
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const activeTabId = button.dataset.tab;
        tabPanels.forEach(panel => {
          if (panel.id === activeTabId) {
            panel.classList.add('active');
          } else {
            panel.classList.remove('active');
          }
        });
        if (activeTabId === 'tab-results') {
          initializeMap();
          calculate();
        }
      });
    });

    function switchToResultsTab() {
        document.querySelector('.tab-button[data-tab="tab-results"]').click();
    }

    function initializeMap() {
      if (!map) {
        map = L.map('map').setView([35.681236, 139.767125], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
      }
    }
    
    function updateMap(coords) {
      if (!map) return;

      mapMarkers.forEach(marker => map.removeLayer(marker));
      mapPolylines.forEach(line => map.removeLayer(line));
      mapMarkers = [];
      mapPolylines = [];

      const validCoords = [];
      const colors = { A: '#007aff', B: '#ff3b30', C: '#34c759', D: '#ff9500' };

      PTS.forEach(pt => {
        const [lat, lon] = coords[pt];
        if (Number.isFinite(lat) && Number.isFinite(lon)) {
          const icon = createMarkerIcon(pt, colors[pt]);
          const marker = L.marker([lat, lon], {icon}).addTo(map).bindPopup(`åœ°ç‚¹ ${pt}<br>${lat.toFixed(5)}, ${lon.toFixed(5)}`);
          mapMarkers.push(marker);
          validCoords.push([lat, lon]);
        }
      });

      mapArbitraryPoints.forEach(point => {
          const icon = createMarkerIcon(point.id, '#9b59b6'); // Purple color for arbitrary points
          const marker = L.marker([point.lat, point.lon], { icon }).addTo(map).bindPopup(`ä»»æ„åœ°ç‚¹ ${point.id}`);
          mapMarkers.push(marker);
          validCoords.push([point.lat, point.lon]);
      });
      
      const pointA = coords.A;
      if(Number.isFinite(pointA[0]) && Number.isFinite(pointA[1])) {
          const northPoint = destPoint(pointA[0], pointA[1], 0, 2); // 2km North
          const northLine = L.polyline([pointA, [northPoint.lat, northPoint.lon]], { color: '#007aff', weight: 3, opacity: 0.8 }).addTo(map);
          mapPolylines.push(northLine);

          const allTargets = [
              ...['B', 'C', 'D'].map(pt => coords[pt]),
              ...mapArbitraryPoints.map(p => [p.lat, p.lon])
          ].filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]));

          allTargets.forEach((targetPoint, index) => {
              const color = lineColors[index % lineColors.length];
              const line = L.polyline([targetPoint, pointA], { color: color, weight: 3, opacity: 0.8 }).addTo(map);
              mapPolylines.push(line);
          });
      }

      if (validCoords.length > 0) {
        map.fitBounds(validCoords, { padding: [50, 50], maxZoom: 16 });
      }
    }

    window.onload=function(){
      const showHelpBtn = document.getElementById('showHelpBtn');
      const helpModal = document.getElementById('help-modal');
      const closeHelpBtn = document.getElementById('closeHelpBtn');

      showHelpBtn.addEventListener('click', () => { helpModal.style.display = 'flex'; });
      closeHelpBtn.addEventListener('click', () => { helpModal.style.display = 'none'; });
      helpModal.addEventListener('click', (e) => { if (e.target === helpModal) { helpModal.style.display = 'none'; } });

      parseUrlInputs();
      
      document.getElementById('any_add_btn').addEventListener('click', addArbitraryLink);
      document.getElementById('any_clear_btn').addEventListener('click', clearArbitrary);
      document.getElementById('getLocationBtn').addEventListener('click', function() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition( function(position) { const lat = position.coords.latitude; const lon = position.coords.longitude; setPair('A', lat, lon); setDecimal('A', lat, lon); setDMSFromDecimal('A', lat, lon); calculate(); showToast('ç¾åœ¨åœ°ã‚’Aã«è¨­å®šã—ã¾ã—ãŸ'); }, function(error) { let msg = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—"; switch(error.code) { case 1: msg = "ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“"; break; case 2: msg = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"; break; case 3: msg = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"; break; } showToast(msg); } ); } else { showToast('ãƒ–ãƒ©ã‚¦ã‚¶ãŒä½ç½®æƒ…å ±å–å¾—ã«éå¯¾å¿œã§ã™'); } });
      
      PTS.forEach(pt=>{ 
          document.getElementById('latlon'+pt).addEventListener('input', calculate);
          ['lat','lon'].forEach(kind=>{ 
              document.getElementById(kind+pt+'_dec').addEventListener('input', calculate);
          }); 
          [['lat','deg'],['lat','min'],['lat','sec'],['lon','deg'],['lon','min'],['lon','sec']].forEach(([k,s])=>{ 
              document.getElementById(k+pt+'_'+s).addEventListener('input', calculate);
          }); 
      });
      
      calculate();
    };
    
    PTS.forEach(pt=>{ 
        document.getElementById('latlon'+pt).addEventListener('change',()=>{ const p = readPair(pt); if (p){ setDecimal(pt, p.lat, p.lon); setDMSFromDecimal(pt, p.lat, p.lon); } });
        ['lat','lon'].forEach(kind=>{ 
            document.getElementById(kind+pt+'_dec').addEventListener('change',()=>{ const dec = readDecimal(pt); if (dec){ setPair(pt, dec.lat, dec.lon); setDMSFromDecimal(pt, dec.lat, dec.lon); } }); 
        }); 
        [['lat','deg'],['lat','min'],['lat','sec'],['lon','deg'],['lon','min'],['lon','sec']].forEach(([k,s])=>{ 
            document.getElementById(k+pt+'_'+s).addEventListener('change',()=>{ const d = readDMS(pt); if (d){ setDecimal(pt, d.lat, d.lon); setPair(pt, d.lat, d.lon); } }); 
        }); 
    });
  </script>
</body>
</html>


